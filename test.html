<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de API - DM 2.0</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0a0a0a;
            color: #fff;
        }
        h1 {
            color: #00ff88;
        }
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00cc6a;
        }
        .log {
            background: #000;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #00ff88; }
        .error { color: #ff4444; }
        .info { color: #4488ff; }
        .warning { color: #ffaa00; }
        input {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test de API - DM 2.0</h1>
    
    <div class="test-section">
        <h2>1. Test de Service Worker</h2>
        <button onclick="testServiceWorker()">Verificar Service Worker</button>
        <div id="sw-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. Test de BÃºsqueda</h2>
        <input type="text" id="search-input" placeholder="Buscar artista/canciÃ³n..." value="robleis">
        <button onclick="testSearch()">Buscar</button>
        <div id="search-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. Test de Failover</h2>
        <button onclick="testFailover()">Probar Failover</button>
        <div id="failover-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>4. Test de Stream URL</h2>
        <input type="text" id="track-id" placeholder="Track ID" value="343011346">
        <button onclick="testStreamUrl()">Obtener Stream URL</button>
        <div id="stream-log" class="log"></div>
    </div>

    <script type="module">
        import { LosslessAPI } from './js/api.js';
        import { SettingsManager } from './js/storage.js';

        // Configurar API
        const settings = new SettingsManager();
        const api = new LosslessAPI(settings);

        // Hacer disponible globalmente para los botones
        window.api = api;
        window.settings = settings;

        // FunciÃ³n auxiliar para logging
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Test 1: Service Worker
        window.testServiceWorker = async function() {
            const logId = 'sw-log';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, 'ðŸ” Verificando Service Worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    
                    if (registration) {
                        log(logId, `âœ“ Service Worker registrado`, 'success');
                        log(logId, `  Scope: ${registration.scope}`, 'info');
                        
                        if (registration.active) {
                            log(logId, `  Estado: ACTIVO`, 'success');
                            log(logId, `  Script: ${registration.active.scriptURL}`, 'info');
                            
                            // Verificar versiÃ³n del cachÃ©
                            const caches = await window.caches.keys();
                            log(logId, `  CachÃ©s disponibles: ${caches.join(', ')}`, 'info');
                            
                            if (caches.includes('monochrome-v3')) {
                                log(logId, `âœ“ CachÃ© v3 encontrado (correcto)`, 'success');
                            } else {
                                log(logId, `âš  CachÃ© v3 NO encontrado. Versiones: ${caches.join(', ')}`, 'warning');
                            }
                        } else {
                            log(logId, `âš  Service Worker no estÃ¡ activo`, 'warning');
                        }
                    } else {
                        log(logId, `âœ— No hay Service Worker registrado`, 'error');
                    }
                } catch (error) {
                    log(logId, `âœ— Error: ${error.message}`, 'error');
                }
            } else {
                log(logId, `âœ— Service Workers no soportados`, 'error');
            }
        };

        // Test 2: BÃºsqueda
        window.testSearch = async function() {
            const logId = 'search-log';
            const query = document.getElementById('search-input').value;
            document.getElementById(logId).innerHTML = '';
            
            log(logId, `ðŸ” Buscando: "${query}"...`, 'info');
            
            try {
                const startTime = performance.now();
                const result = await api.searchTracks(query);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                log(logId, `âœ“ BÃºsqueda exitosa en ${duration}ms`, 'success');
                log(logId, `  Resultados: ${result.items.length}`, 'info');
                
                if (result.items.length > 0) {
                    result.items.slice(0, 3).forEach((track, i) => {
                        log(logId, `  ${i + 1}. ${track.title} - ${track.artist?.name || 'Unknown'}`, 'info');
                    });
                }
            } catch (error) {
                log(logId, `âœ— Error: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Test 3: Failover
        window.testFailover = async function() {
            const logId = 'failover-log';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, 'ðŸ”„ Probando failover entre instancias...', 'info');
            
            const instances = settings.getInstances();
            log(logId, `  Instancias configuradas: ${instances.length}`, 'info');
            
            for (let i = 0; i < Math.min(3, instances.length); i++) {
                const instance = instances[i];
                log(logId, `  Probando: ${instance}`, 'info');
                
                try {
                    const startTime = performance.now();
                    const response = await fetch(`${instance}/search/?s=test`, {
                        signal: AbortSignal.timeout(5000),
                        mode: 'cors'
                    });
                    const endTime = performance.now();
                    const duration = (endTime - startTime).toFixed(2);
                    
                    if (response.ok) {
                        log(logId, `    âœ“ OK (${duration}ms)`, 'success');
                    } else {
                        log(logId, `    âœ— Error ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(logId, `    âœ— ${error.message}`, 'error');
                }
            }
        };

        // Test 4: Stream URL
        window.testStreamUrl = async function() {
            const logId = 'stream-log';
            const trackId = document.getElementById('track-id').value;
            document.getElementById(logId).innerHTML = '';
            
            log(logId, `ðŸŽµ Obteniendo stream URL para track ${trackId}...`, 'info');
            
            try {
                const startTime = performance.now();
                const streamUrl = await api.getStreamUrl(trackId, 'LOSSLESS');
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                log(logId, `âœ“ Stream URL obtenido en ${duration}ms`, 'success');
                log(logId, `  URL: ${streamUrl.substring(0, 100)}...`, 'info');
                
                // Verificar que la URL es accesible
                log(logId, `  Verificando accesibilidad...`, 'info');
                const response = await fetch(streamUrl, { 
                    method: 'HEAD',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    log(logId, `  âœ“ URL accesible`, 'success');
                    log(logId, `  Content-Type: ${response.headers.get('content-type')}`, 'info');
                    log(logId, `  Content-Length: ${response.headers.get('content-length')} bytes`, 'info');
                } else {
                    log(logId, `  âœ— URL no accesible (${response.status})`, 'error');
                }
            } catch (error) {
                log(logId, `âœ— Error: ${error.message}`, 'error');
                console.error(error);
            }
        };

        // Auto-ejecutar test de SW al cargar
        setTimeout(() => {
            testServiceWorker();
        }, 500);
    </script>
</body>
</html>
